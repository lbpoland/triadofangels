<!-- album.html -->
<!DOCTYPE html>
<html lang="en" dir="ltr" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Triad of Angels - A cosmic creative force delivering cinematic pop, heavy metal, country music, games, and apps. Join the movement of hope, strength, and fire.">
  <meta name="keywords" content="Triad of Angels, ToA Studios, cinematic pop, heavy metal, country music, games, apps, merch, creativity, innovation, hope, strength, fire, Serpent's Veil, American Firestorm, Angel Wars">
  <meta name="author" content="Triad of Angels & ToA Studios">
  <meta name="theme-color" content="#0b0c10">
  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta property="og:title" content="Triad of Angels | Official Website">
  <meta property="og:description" content="Discover Triad of Angels: cinematic pop, heavy metal, country music, games, apps, and more, powered by ToA Studios’ innovative spirit.">
  <meta property="og:image" content="/assets/images/og-banner.webp">
  <meta property="og:image:alt" content="Triad of Angels cosmic banner">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://www.triadofangels.com">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Triad of Angels">
  <meta property="og:locale" content="en_US">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@triadofangels">
  <meta name="twitter:creator" content="@triadofangels">
  <meta name="twitter:title" content="Triad of Angels | Official Website">
  <meta name="twitter:description" content="Explore the universe of Triad of Angels: music, games, apps, and creative innovation.">
  <meta name="twitter:image" content="/assets/images/og-banner.webp">
  <link rel="canonical" href="https://www.triadofangels.com">
  <link rel="icon" type="image/webp" href="/assets/images/favicon.webp" sizes="any">
  <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.webp">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://firestore.googleapis.com">
  <link rel="stylesheet" href="/css/style.css?v=7">
  <link rel="stylesheet" href="/css/chatbot.css?v=7">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@300;400;600;700&display=swap" media="print" onload="this.media='all'">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Triad of Angels",
    "url": "https://www.triadofangels.com",
    "logo": "/assets/images/logo.webp",
    "sameAs": [
      "https://www.tiktok.com/@triadofangels",
      "https://www.instagram.com/triadofangels/",
      "https://www.youtube.com/@triadofangels",
      "https://www.facebook.com/triadofangels",
      "https://x.com/triadofangels"
    ],
    "description": "Triad of Angels is a creative powerhouse delivering cinematic pop, heavy metal, country music, games, apps, and more, driven by hope, strength, and innovation.",
    "contactPoint": {
      "@type": "ContactPoint",
      "email": "contact@triadofangels.com",
      "contactType": "Customer Support"
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://www.triadofangels.com",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://www.triadofangels.com/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  <script type="application/ld+json">
  [
    {
      "@context": "https://schema.org",
      "@type": "MusicAlbum",
      "name": "Serpent's Veil",
      "byArtist": {
        "@type": "MusicGroup",
        "name": "ToA Studios"
      },
      "genre": "Heavy Metal, Rock, Alternative",
      "datePublished": "2025-06-19",
      "url": "https://www.triadofangels.com/album.html?id=serpents-veil",
      "image": "/assets/images/albums/serpentsveil-album.webp",
      "sameAs": "https://music.apple.com/au/album/serpents-veil/1813142997"
    },
    {
      "@context": "https://schema.org",
      "@type": "MusicAlbum",
      "name": "American Firestorm Songs of Freedom",
      "byArtist": {
        "@type": "MusicGroup",
        "name": "ToA Studios"
      },
      "genre": "Country",
      "datePublished": "2025-06-20",
      "url": "https://www.triadofangels.com/album.html?id=american-firestorm-songs-of-freedom",
      "image": "/assets/images/albums/songsoffreedom-album.webp",
      "sameAs": "https://music.apple.com/au/album/american-firestorm-songs-of-freedom/1813521823"
    },
    {
      "@context": "https://schema.org",
      "@type": "MusicAlbum",
      "name": "Wings of Fire",
      "byArtist": {
        "@type": "MusicGroup",
        "name": "Triad of Angels"
      },
      "genre": "Cinematic Pop",
      "datePublished": "2024-12-01",
      "url": "https://www.triadofangels.com/album.html?id=wings-of-fire",
      "image": "/assets/images/albums/wings-of-fire-album.webp",
      "sameAs": "https://music.apple.com/us/album/wings-of-fire-ep/1812163266"
    },
    {
      "@context": "https://schema.org",
      "@type": "MusicAlbum",
      "name": "Ascend",
      "byArtist": {
        "@type": "MusicGroup",
        "name": "Triad of Angels"
      },
      "genre": "Cinematic Pop",
      "datePublished": "2025-01-15",
      "url": "https://www.triadofangels.com/album.html?id=ascend",
      "image": "/assets/images/albums/ascend-album.webp",
      "sameAs": "https://music.apple.com/us/album/ascend/1812603057"
    }
  ]
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://www.triadofangels.com"
      }
    ]
  }
  </script>
  <title>Album Details | Triad of Angels & ToA Studios</title>
  <style>
    /* Album-specific styles (non-comment related) */
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      background: transparent;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.9) 0%,
        rgba(0, 0, 0, 0.3) 50%,
        rgba(0, 0, 0, 0) 100%
      ),
      linear-gradient(
        to right,
        rgba(241, 196, 15, 0.08) 0%,
        rgba(0, 0, 0, 0.5) 50%,
        rgba(241, 196, 15, 0.08) 100%
      );
      z-index: -1;
      pointer-events: none;
    }

    .album-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
      pointer-events: none;
      filter: blur(5px);
    }

    .album-container {
      position: relative;
      color: #f5f5f5;
      font-family: 'Montserrat', sans-serif;
      min-height: 100vh;
      z-index: 0;
    }

    .album-hero {
      position: relative;
      min-height: 100vh;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 40px;
      box-sizing: border-box;
    }

    .album-hero-content {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      padding: 50px;
      background: rgba(15, 15, 15, 0.6);
      border-radius: 35px;
      box-shadow: 0 0 80px rgba(241, 196, 15, 0.1), inset 0 0 25px rgba(241, 196, 15, 0.05);
      border: 2px solid rgba(241, 196, 15, 0.15);
      backdrop-filter: blur(20px);
    }

    .album-hero-content h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 5rem;
      font-weight: 900;
      letter-spacing: 5px;
      text-transform: uppercase;
      background: linear-gradient(45deg, #f1c40f, #ffeb3b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.6), 0 0 60px rgba(241, 196, 15, 0.4);
      margin-bottom: 30px;
      animation: glow 5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      0% { text-shadow: 0 0 30px rgba(241, 196, 15, 0.6), 0 0 60px rgba(241, 196, 15, 0.4); }
      100% { text-shadow: 0 0 40px rgba(241, 196, 15, 0.8), 0 0 80px rgba(241, 196, 15, 0.6); }
    }

    .album-hero-content p {
      font-size: 2rem;
      color: #e8e8e8;
      font-weight: 300;
      letter-spacing: 2px;
      text-shadow: 0 4px 10px rgba(0, 0, 0, 0.9);
      font-style: italic;
    }

    .album-main {
      max-width: 1300px;
      margin: 0 auto;
      padding: 120px 40px;
      position: relative;
      z-index: 2;

    }

    .album-details {
      display: flex;
      flex-wrap: wrap;
      gap: 70px;
      background: rgba(20, 20, 20, 0.9);
      border-radius: 40px;
      padding: 70px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9), inset 0 0 35px rgba(241, 196, 15, 0.02);
      border: 2px solid rgba(241, 196, 15, 0.1);
      margin-bottom: 70px;
      opacity: 1;
    }

    .album-cover {
      flex: 1;
      min-width: 0;
      text-align: center;
      position: relative;
    }

    .album-cover img {
      width: 100%;
      max-width: 550px;
      height: auto;
      border-radius: 35px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9), 0 0 50px rgba(241, 196, 15, 0.1);
      transition: transform 0.8s ease, box-shadow 0.8s ease;
      border: 3px solid rgba(241, 196, 15, 0.2);
      object-fit: cover;
      loading: lazy;
    }

    .album-cover img:hover {
      transform: scale(1.02);
      box-shadow: 0 35px 80px rgba(0, 0, 0, 0.95), 0 0 60px rgba(241, 196, 15, 0.25);
    }

    .album-info {
      flex: 2;
      min-width: 0;
    }

    .album-info h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      color: #f1c40f;
      margin-bottom: 35px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
    }

    .album-info p {
      font-size: 1.4rem;
      color: #dbdbdb;
      margin: 20px 0;
      line-height: 2;
      font-weight: 300;
    }

    .album-info p strong {
      color: #f5f5f5;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    #album-description {
      margin-top: 30px;
      font-size: 1.5rem;
      color: #e8e8e8;
      font-style: italic;
      background: rgba(241, 196, 15, 0.02);
      padding: 30px;
      border-radius: 15px;
      border-left: 5px solid #f1c40f;
      line-height: 2;
      box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.3);
    }

    .streaming-links {
      background: rgba(20, 20, 20, 0.9);
      border-radius: 40px;
      padding: 70px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9), inset 0 0 35px rgba(241, 196, 15, 0.02);
      border: 2px solid rgba(241, 196, 15, 0.1);
      text-align: center;
      margin-bottom: 70px;
      opacity: 1;
    }

    .streaming-links h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      color: #f1c40f;
      margin-bottom: 50px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
    }

    .link-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .link-tab {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 28px;
      background: linear-gradient(45deg, #f1c40f, #ffeb3b);
      color: #0a0a0a;
      text-decoration: none;
      border-radius: 30px;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(241, 196, 15, 0.2), inset 0 0 5px rgba(255, 235, 59, 0.1);
      border: 1px solid rgba(241, 196, 15, 0.4);
      letter-spacing: 1px;
    }

    .link-tab:hover {
      background: linear-gradient(45deg, #ffeb3b, #f1c40f);
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4), inset 0 0 10px rgba(255, 235, 59, 0.2);
    }

    .link-tab:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.5);
    }

    .music-player {
      background: rgba(20, 20, 20, 0.9);
      border-radius: 40px;
      padding: 70px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9), inset 0 0 35px rgba(241, 196, 15, 0.02);
      border: 2px solid rgba(241, 196, 15, 0.1);
      text-align: center;
      margin-bottom: 70px;
      opacity: 1;
    }

    .music-player h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      color: #f1c40f;
      margin-bottom: 50px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
    }

    .music-player iframe {
      width: 100%;
      max-width: auto;
      max-width: auto;
      height: 1000px;
      border: none;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      background: rgba(0, 0, 0, 0.9);
    }

    .music-player p {
      font-size: 1.4rem;
      color: #dbdbdb;
      font-style: italic;
      margin-top: 30px;
    }

    .error-section {
      background: rgba(20, 20, 20, 0.9);
      border-radius: 40px;
      padding: 70px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9);
      border: 2px solid rgba(241, 196, 15, 0.1);
      text-align: center;
      max-width: 900px;
      margin: 50px auto;
      opacity: 1;
    }

    .error-section h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      font-weight: 800;
      color: #f1c40f;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
    }

    .error-section p {
      font-size: 1.4rem;
      color: #dbdbdb;
      line-height: 2;
    }

    .comments-section {
      background: rgba(20, 20, 20, 0.9);
      border-radius: 40px;
      padding: 70px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9), inset 0 0 35px rgba(241, 196, 15, 0.02);
      border: 2px solid rgba(241, 196, 15, 0.1);
      margin-bottom: 70px;
      opacity: 1;
      min-height: 200px;
      overflow: visible;
      position: relative;
      z-index: 2;
    }

    .comments-section h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      color: #f1c40f;
      margin-bottom: 50px;
      text-transform: uppercase;
      letter-spacing: 5px;
      text-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
    }

    @media (max-width: 1024px) {
      .album-hero {
        min-height: 90vh;
      }

      .album-hero-content h1 {
        font-size: 4.5rem;
      }

      .album-hero-content p {
        font-size: 1.8rem;
      }

      .album-details {
        flex-direction: column;
        align-items: center;
        padding: 50px;
        gap: 50px;
      }

      .album-cover img {
        max-width: 500px;
      }

      .album-info h2 {
        font-size: 3rem;
      }

      .album-info p {
        font-size: 1.3rem;
      }

      #album-description {
        font-size: 1.4rem;
      }

      .streaming-links,
      .music-player,
      .comments-section {
        padding: 50px;
      }

      .streaming-links h2,
      .music-player h2,
      .comments-section h2 {
        font-size: 3rem;
      }
    }

    @media (max-width: 768px) {
      .album-hero {
        min-height: 80vh;
        padding: 0 15px;
      }

      .album-hero-content {
        padding: 30px;
        border-radius: 25px;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
      }

      .album-hero-content h1 {
        font-size: 3.5rem;
      }

      .album-hero-content p {
        font-size: 1.5rem;
      }

      .album-main {
        padding: 40px 15px;
      }

      .album-details {
        padding: 30px;
        gap: 30px;
      }

      .album-cover {
        flex: none;
        width: 100%;
      }

      .album-cover img {
        max-width: 100%;
        width: 100%;
      }

      .album-info {
        flex: none;
        width: 100%;
      }

      .album-info h2 {
        font-size: 2.5rem;
        letter-spacing: 3px;
      }

      .album-info p {
        font-size: 1.2rem;
      }

      #album-description {
        font-size: 1.3rem;
        padding: 20px;
      }

      .streaming-links,
      .music-player,
      .comments-section {
        padding: 30px 15px;
      }

      .streaming-links h2,
      .music-player h2,
      .comments-section h2 {
        font-size: 2.5rem;
        letter-spacing: 3px;
      }

  .link-tabs {
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
  }

  .link-tab {
    width: 90%;
    padding: 12px 0;
    font-size: 0.9rem;
    border-radius: 20px;
    text-align: center;
  }


      .music-player iframe {
        height: 900px;
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .album-hero {
        min-height: 60vh;
        padding: 0 10px;
      }

      .album-hero-content {
        padding: 20px;
        border-radius: 20px;
      }

      .album-hero-content h1 {
        font-size: 2.8rem;
        letter-spacing: 3px;
      }

      .album-hero-content p {
        font-size: 1.3rem;
      }

      .album-main {
        padding: 30px 10px;
      }

      .album-details {
        padding: 20px;
        gap: 20px;
      }

      .album-cover img {
        max-width: 100%;
      }

      .album-info h2 {
        font-size: 2rem;
        letter-spacing: 2px;
      }

      .album-info p {
        font-size: 1.1rem;
      }

      #album-description {
        font-size: 1.2rem;
        padding: 15px;
      }

      .streaming-links,
      .music-player,
      .comments-section {
        padding: 20px 10px;
      }

      .streaming-links h2,
      .music-player h2,
      .comments-section h2 {
        font-size: 2rem;
        letter-spacing: 2px;
      }



  .link-tab {
    width: 95%;
    padding: 10px 0;
    font-size: 0.85rem;
    border-radius: 18px;
  }

      .music-player iframe {
        height: 900px;
        max-width: 100%;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .link-tab,
      .album-cover img,
      .album-details,
      .streaming-links,
      .music-player,
      .comments-section {
        transition: none;
        animation: none;
      }

      .link-tab:hover,
      .album-cover img:hover {
        transform: none;
      }

      .album-hero-content h1 {
        animation: none;
        text-shadow: 0 0 30px rgba(241, 196, 15, 0.6);
      }
    }
	.hero-content { display: none; }
    .hero-content h1 { display: none; }
    .hero-content h2 { display: none; }
    .hero-content p { display: none; }
	
  </style>
</head>

<body class="album-page">
  <!-- Album Background -->
  <img id="album-background" class="album-background" alt="Blurred album cover background" loading="lazy" />
  <header role="banner">
    <nav role="navigation" aria-label="Main site navigation">
      <button id="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
        <span class="menu-icon">☰</span>
        <span class="menu-label">Menu</span>
      </button>
      <ul id="main-nav" role="list">
        <li><a href="/index.html" aria-current="page">Home</a></li>
        <li><a href="/about.html">About</a></li>
        <li><a href="/music.html">Music</a></li>
        <li><a href="/visual.html">Visual</a></li>
        <li><a href="/games.html">Games</a></li>
        <li><a href="/apps.html">Apps</a></li>
        <li><a href="/merch.html">Merch</a></li>
        <li><a href="/publishing.html">Publishing</a></li>
        <li><a href="/digital-store.html">Digital Store</a></li>
        <li><a href="/contact.html">Contact</a></li>
        <li id="auth-nav-item">
          <div id="global-auth-ui" role="region" aria-live="polite">
            <span id="global-user-name" aria-label="Current user">Guest</span>
            <button id="global-login-btn" aria-label="Sign in with Google">Sign In</button>
            <button id="global-logout-btn" aria-label="Sign out" style="display: none;">Logout</button>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <div class="album-container">
    <!-- Album Hero Section -->
    <section class="album-hero" aria-label="Album hero section">
      <div class="album-hero-content">
        <h1 id="album-title">Loading...</h1>
        <p id="album-subtitle">A Masterpiece by Triad of Angels & ToA Studios</p>
      </div>
    </section>

    <main class="album-main">
      <!-- Album Details -->
      <section class="album-details" aria-label="Album details">
        <div class="album-cover">
          <img id="album-cover" alt="Album cover" loading="lazy" />
        </div>
        <div class="album-info">
          <h2 id="album-info-title">Loading...</h2>
          <p id="album-artist"><strong>Artist:</strong> Loading...</p>
          <p id="album-tracks"><strong>Tracks:</strong> Loading...</p>
          <p id="album-genre"><strong>Genre:</strong> Loading...</p>
          <p id="album-year"><strong>Release Date:</strong> Loading...</p>
          <p id="album-description">Loading...</p>
        </div>
      </section>

      <!-- Streaming Links -->
      <section class="streaming-links" aria-label="Streaming and purchase links">
        <h2>Stream or Purchase</h2>
        <div id="link-tabs" class="link-tabs"></div>
      </section>

      <!-- Music Player -->
      <section class="music-player" aria-label="Music player embed">
        <h2>Listen Now</h2>
        <div id="music-player-embed"></div>
      </section>

      <!-- Comments Section -->
      <section class="comments-section" aria-label="Album comments">
        <h2>Comments</h2>
        <div class="comment-form">
          <textarea id="comment-input" placeholder="Write your comment here..." aria-label="Comment input" disabled></textarea>
          <button id="submit-comment" disabled>Post Comment</button>
        </div>
        <div class="comment-list" id="comment-list"></div>
      </section>
    </main>
  </div>

  <footer role="contentinfo" aria-label="Site footer">
    <p>© 2025 Triad of Angels & ToA Studios. All rights reserved.</p>
    <nav aria-label="Footer navigation">
      <ul>
        <li><a href="/index.html" aria-current="page">Home</a></li>
        <li><a href="/terms.html">Terms & Conditions</a></li>
        <li><a href="/privacy.html">Privacy Policy</a></li>
        <li><a href="/contact.html">Contact</a></li>
      </ul>
    </nav>
    <div class="divider"></div>
    <div class="social-links" aria-label="Social media links">
      <a href="https://www.tiktok.com/@triadofangels" target="_blank" rel="noopener" aria-label="Follow Triad of Angels on TikTok">
        <img src="/assets/icons/tiktok-icon.webp" alt="TikTok logo" width="24" height="24" loading="lazy">
        <span>TikTok</span>
      </a>
      <a href="https://www.instagram.com/triadofangels/" target="_blank" rel="noopener" aria-label="Follow Triad of Angels on Instagram">
        <img src="/assets/icons/instagram-icon.webp" alt="Instagram logo" width="24" height="24" loading="lazy">
        <span>Instagram</span>
      </a>
      <a href="https://www.youtube.com/@triadofangels" target="_blank" rel="noopener" aria-label="Subscribe to Triad of Angels on YouTube">
        <img src="/assets/icons/youtube-icon.webp" alt="YouTube logo" width="24" height="24" loading="lazy">
        <span>YouTube</span>
      </a>
      <a href="https://www.facebook.com/triadofangels" target="_blank" rel="noopener" aria-label="Like Triad of Angels on Facebook">
        <img src="/assets/icons/facebook-icon.webp" alt="Facebook logo" width="24" height="24" loading="lazy">
        <span>Facebook</span>
      </a>
      <a href="https://x.com/triadofangels" target="_blank" rel="noopener" aria-label="Follow Triad of Angels on X">
        <img src="/assets/icons/x-icon.webp" alt="X logo" width="24" height="24" loading="lazy">
        <span>X</span>
      </a>
    </div>
  </footer>

  <div id="toa-chatbot" role="region" aria-label="Triad of Angels Helpdesk">
    <button id="chatbot-icon" title="Need help? Chat with us!" aria-label="Toggle chatbot window" aria-controls="chatbot-window">
      <img src="/assets/images/chatbot.webp" alt="Triad of Angels Chatbot Icon" width="56" height="56" loading="lazy">
    </button>
    <div id="chatbot-window" class="hidden" role="dialog" aria-labelledby="chatbot-header">
      <div id="chatbot-header">
        <strong>Triad of Angels Helpdesk</strong>
        <button id="chatbot-close-button" aria-label="Close chatbot window">❌</button>
      </div>
      <div id="chatbot-body" role="log" aria-live="polite"></div>
      <div id="chatbot-input">
        <input type="text" id="user-input" placeholder="Ask me anything..." aria-label="Chat input">
        <button id="chatbot-send-button" aria-label="Send message">Send</button>
        <button id="chatbot-reset-button" aria-label="Reset conversation">Reset Chat</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { auth, db } from './js/firebase-init.js';
    import './js/auth.js';

    // Album data
    const albums = [
      {
        id: "wings-of-fire",
        title: "Wings of Fire",
        artist: "Triad of Angels",
        genre: "Female Group, Cinematic Pop, Orchestral, Ballad",
        year: "May, 2025",
        cover: "assets/images/albums/wingsoffire-album.webp",
        tracks: ["wings of Fire", "We are the Triad", "Starlight Wounds"],
        links: {
          spotify: "https://open.spotify.com/album/4K83YJEeETmcybKtQ1LP5l?si=fOFELopLS9W3eLOSR8x5tA",
          appleMusic: "https://music.apple.com/us/album/wings-of-fire-ep/1812163266",
          amazonMusic: "https://music.amazon.com/albums/B0F79L26WV?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_LjFRykAfbo5PSnB7mT8yMjN2a",
          iHeartRadio: "https://www.iheart.com/artist/triad-of-angels-46655903/albums/wings-of-fire-326706390/",
          boomplay: "https://www.boomplay.com/albums/110140275?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/SvK8hbw8DH1q33xXA",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_kpbLV2nL-Ryt_nKkJ8CFfll701Zrw9N6k&si=c0d1GLRChrOKtkbK",
          iTunes: "https://music.apple.com/us/album/wings-of-fire-ep/1812163266"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110140275/COL",
        artistInfo: "This is the first (among many) Albums from the Female Group *Triad of Angels* releasing their EP Album. This Album has cinematic pop sounds, melodies, beautiful soul touching sounds that blends powerful vocals with orchestral elements. *Wings of Fire* showcases their signature style, weaving themes of hope, strength, and fiery passion."
      },
      {
        id: "ascend",
        title: "Ascend",
        artist: "Triad of Angels",
        genre: "Female Group, Cinematic Pop, Orchestral, Alternative, Soundtrack",
        year: "May, 2025",
        cover: "assets/images/albums/ascend-album.webp",
        tracks: ["Fireproof", "Home to My Heart", "Unseen Wings"],
        links: {
          spotify: "https://open.spotify.com/album/5EetoHOZzPFoLGfM7XzTim?si=cWzTT5jKQ5KI-KkQYubADQ",
          appleMusic: "https://music.apple.com/us/album/ascend/1812603057",
          amazonMusic: "https://music.amazon.com/albums/B0F7H65CHH?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_8rBuhB66DVXsHWGPokhzw88DN",
          iHeartRadio: "https://www.iheart.com/artist/triad-of-angels-46655903/albums/ascend-327002587/",
          boomplay: "https://www.boomplay.com/albums/110238502?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/M4d8bxxmmQdLEr3o7",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_n6axY2s6JOnfyXOqSsWQ9o1Rmz05azC4w&si=5HJAAMnu0iXVlpNb",
          iTunes: "https://music.apple.com/us/album/ascend/1812603057"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110238502/COL",
        artistInfo: "Triad of Angels is the Female Group of Samantha, Jessica & Sonya. Cinematic pop sound that blends powerful vocals with orchestral elements. *Ascend* takes listeners on a journey of uplifting melodies and soaring emotions with true inspirations and belief."
      },
      {
        id: "probed-and-confused",
        title: "Probed & Confused",
        artist: "ToA Studios",
        genre: "Hip-Hop, Rap, Satirical, Parody, Electronic",
        year: "May, 2025",
        cover: "assets/images/albums/probedandconfused-album.webp",
        tracks: ["Strings Attached", "Project Blue Beam", "The Great Goodbye"],
        links: {
          spotify: "https://open.spotify.com/album/5pdZRwo8VXH3sxTZzqsUjN?si=nDt0mqEjQ82k-TaymTQYZQ",
          appleMusic: "https://music.apple.com/us/album/probed-confused/1812599708",
          amazonMusic: "https://music.amazon.com/albums/B0F7H6DL4J?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_72nUB1xSWdSCwKH8CX7EColXP",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/probed-confused-327006359/",
          boomplay: "https://www.boomplay.com/albums/110242229?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/UgaQkHSdvSTSWf7Y8",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_nZawrRr1jGQNAw3nz0P2B-OoqMKmEn1Tg&si=v-I7avviDAjL1VW0",
          iTunes: "https://music.apple.com/us/album/probed-confused/1812599708"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110242229/COL",
        artistInfo: "ToA Studios explores the unknown with *Probed & Confused*, an electronic journey from the view of an Alien that has landed on Earth touching base on all the *conspiracies* among us. This is a hip-hop/rap focus story from start to end (Goodbye) with cosmic confusion and extraterrestrial vibes. Satirical fun."
      },
      {
        id: "echoes-on-the-dirt-road",
        title: "Echoes on the Dirt Road",
        artist: "ToA Studios",
        genre: "Country, Ballad, Boot Scootin', Alternative",
        year: "May, 2025",
        cover: "assets/images/albums/echoesonthedirtroad-album.webp",
        tracks: ["Echoes on the Dirt Road", "Rust & Roses", "Boot, Scoot & Spin"],
        links: {
          spotify: "https://open.spotify.com/album/0y1rCdAJggJMoFvX1FFKDe?si=Vo8Gj9uXSku2-6WzY6HgQg",
          appleMusic: "https://music.apple.com/us/album/echoes-on-the-dirt-road/1812611626",
          amazonMusic: "https://music.amazon.com/albums/B0F7H6LXVZ?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_iqGT0j3cMSEGDIQiC59dy6977",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/echoes-on-the-dirt-road-327006297/",
          boomplay: "https://www.boomplay.com/albums/110238994?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/g2169XseSm3paGi38",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_mL9FznTyx_-6nKq_rm767o73cjLlUCl_g&si=oprCNIO-vF3nwcuH",
          iTunes: "https://music.apple.com/us/album/echoes-on-the-dirt-road/1812611626"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110238994/COL",
        artistInfo: "ToA Studios presents *Echoes on the Dirt Road*, a heartfelt country album capturing the soul of rural life with hauntingly beautiful melodies. Featuring a viral Boot, Scoot & Spin song for those Line Dancers and Boot Scooters among us!"
      },
      {
        id: "phoenix-rising",
        title: "Phoenix Rising",
        artist: "ToA Studios",
        genre: "Rock, Metal, Alternative, Orchestral",
        year: "May, 2025",
        cover: "assets/images/albums/phoenixrising-album.webp",
        tracks: [""],
        links: {
          spotify: "https://open.spotify.com/album/5xqK1MMJrhPOcPM58zjlvE?si=mn6Yx15fQkGzTLKPOPNE7Q",
          appleMusic: "https://music.apple.com/us/album/phoenix-rising/1812648146",
          amazonMusic: "https://music.amazon.com/albums/B0F7HKT32B?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_2uGXo9FM5fP0z0IDqTunHMEFQ",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/phoenix-rising-327032664/",
          boomplay: "https://www.boomplay.com/albums/110247179?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/wpiRxBm7aijHYBts7",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_mcj1x0UNnDOgYxEpw_3dsQWykLrAOPXj4&si=lzimoRyOpANWfQAb",
          iTunes: "https://music.apple.com/us/album/phoenix-rising/1812648146"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110247179/COL",
        artistInfo: "ToA Studios delivers *Phoenix Rising*, an orchestral with heavy rock masterpiece symbolizing renewal and resilience through soaring compositions."
      },
      {
        id: "the-quiet-war",
        title: "The Quiet War",
        artist: "ToA Studios",
        genre: "Concept Soundtrack, Hip-Hop, Rap",
        year: "May, 2025",
        cover: "assets/images/albums/thequietwar-album.webp",
        tracks: [""],
        links: {
          spotify: "https://open.spotify.com/album/5grqzzq1V4Gaw3jqDjoQbV?si=7YUpINOaRmaKSuYdtlVzvQ",
          appleMusic: "https://music.apple.com/us/album/the-quiet-war/1812870604",
          amazonMusic: "https://music.amazon.com/albums/B0F7LTGSTV?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_Kd4MIeBYuzAoFY3yaobhY11t6",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/the-quiet-war-327214148/",
          boomplay: "https://www.boomplay.com/albums/110301296?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/W8dvTRvGoCzDwxc98",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_mnAyAE1pxoey93kvk6KxqaY8n3CDJtD-0&si=RdO6K4pEyqJVxWQ-",
          iTunes: "https://music.apple.com/us/album/the-quiet-war/1812870604"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110301296/COL",
        artistInfo: "ToA Studios crafts *The Quiet War*, a gripping soundtrack for an untold story of inner battles and silent victories."
      },
      {
        id: "reality-exe",
        title: "Reality.exe",
        artist: "ToA Studios",
        genre: "Hip-Hop, Rap, Satirical, Parody, Electronic",
        year: "May, 2025",
        cover: "assets/images/albums/reality-exe-album.webp",
        tracks: ["Just Roast it!", "Presidential Roast", "Oops… I Thinked Again"],
        links: {
          spotify: "https://open.spotify.com/album/6SzYfretgTzLUITlIP6AMy?si=f2cObGo4STKF-YQusk5YGg",
          appleMusic: "https://music.apple.com/us/album/reality-exe/1812900765",
          amazonMusic: "https://music.amazon.com/albums/B0F7M1HTYD?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_HpaPCWwzNgVC3Y7pxhTXOJQqW",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/realityexe-327233858/",
          boomplay: "https://www.boomplay.com/albums/110303684?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/nSpcy613QhmzKCi7A",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_mEUI3xipOKn-zGt9dOHJbIuk6e1J7gHLQ&si=UuVUiJ6uhXTmNmR_",
          iTunes: "https://music.apple.com/us/album/reality-exe/1812900765"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110303684/COL",
        artistInfo: "ToA Studios reboots reality with *Reality.exe*, a satirical comedy roast fest whilst pointing out the reality of the World and Society as we know it. Hip-hop and rap focus album that glitches through the fabric of existence with pulsating beats."
      },
      {
        id: "serpents-veil",
        title: "Serpent's Veil",
        artist: "ToA Studios",
        genre: "Rock, Metal, Heavy, Alternative",
        year: "19th of May, 2025",
        cover: "assets/images/albums/serpentsveil-album.webp",
        tracks: [""],
        links: {
          spotify: "https://open.spotify.com/album/7nAY1Kggu7JKGEuhUpDvE6?si=URisRlIBQDeXDXlcjPEIHA",
          appleMusic: "https://music.apple.com/us/album/serpents-veil/1813142997",
          amazonMusic: "https://music.amazon.com/albums/B0F7RN4M2P?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_ms5x6LXJsoOEms2jWCkwSfaGB",
          iHeartRadio: "https://www.iheart.com/artist/toa-studios-46720429/albums/serpents-veil-327439389/",
          boomplay: "https://www.boomplay.com/albums/110357635?srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/8v1GujQ7ekat41JQ6",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_nCLvHBjqXqReqWVx1rMQTrwCUYc2u-pj0&si=0C-fKBT3XUcnwYEY",
          iTunes: "https://music.apple.com/au/album/serpents-veil/1813142997"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/110357635/COL",
        artistInfo: "ToA Studios presents *Serpent's Veil*, a heavy metal journey through dark and powerful themes, blending intense riffs with atmospheric elements."
      },
      {
        id: "celestia-the-light-within",
        title: "Celestia: The Light Within",
        artist: "Triad of Angels",
        genre: "Cinematic, Pop, Ballads, Dance, Alternative",
        year: "28th of May, 2025",
        cover: "assets/images/albums/celestia-the-light-within-album.webp",
        tracks: ["Aurora Rising", "Wings of Grace", "Echoes of Eternity", "Elysian Groove", "Sacred Ground", "Soulkeeper", "Cosmic Boots", "Celestial Dance", "Harmony's Call", "Mirror of the Soul", "Hearts Made of Fire", "Halo Burn", "Through the Flame (I Am)", "Celestia (The Light Within)"],
        links: {
          spotify: "https://open.spotify.com/album/567eYko6C0VuGXKq4myvIC?si=pvGKdX-UQAa9q-XOwvpqkQ",
          appleMusic: "https://music.apple.com/us/artist/triad-of-angels/1811109753",
          amazonMusic: "https://music.amazon.com/albums/B0F9PZSYFS?marketplaceId=A15PK738MTQHSO&musicTerritory=AU&ref=dm_sh_jSnNBcS95MzjpfHhuMMAq6Y21",
          iHeartRadio: "https://www.iheart.com/artist/triad-of-angels-46655903/albums/ascend-327002587/",
          boomplay: "https://www.boomplay.com/albums/111117350?from=search&srModel=COPYLINK&srList=WEB",
          deezer: "https://dzr.page.link/1Bk54PWgSNZrxW6B9",
          youTubeMusic: "https://music.youtube.com/playlist?list=OLAK5uy_kj2xaQyIOlhLxcXxpBy4nzhUXhrWaUlic&si=UGXcIqtMu7Xwypm0",
          iTunes: "https://music.apple.com/au/album/celestia-the-light-within/1816427789"
        },
        boomplayEmbed: "https://www.boomplay.com/embed/111117350/COL",
        artistInfo: "Triad of Angels releases their new album - Celestia: The Light Within"
      },
      {
        id: "american-firestorm-songs-of-freedom",
        title: "American Firestorm Songs of Freedom",
        artist: "ToA Studios",
        genre: "Country, Ballad, Funk, Classical, Alternative, Pop",
        year: "20th of June, 2025",
        cover: "assets/images/albums/songsoffreedom-album.webp",
        tracks: ["Light up the Weekend", "Red White and Country Strong", "Born to Ride Free", "Stars Across the Water", "Where the Brave Still Stand", "Where We Belong Tonight", "Fireworks and Freedom", "Born for the Red, White, and blue", "Raise That Flag", "Living Free in America", "Home Beneathe the Stars", "American Firelight", "Run the Red, White, and blue", "Land That I Love"],
        links: {
          spotify: "",
          appleMusic: "",
          amazonMusic: "",
          iHeartRadio: "",
          boomplay: "",
          deezer: "",
          youTubeMusic: "",
          iTunes: "https://music.apple.com/au/album/american-firestorm-songs-of-freedom/1813521823"
        },
        boomplayEmbed: "",
        artistInfo: "ToA Studios delivers *American Firestorm Songs of Freedom*, a diverse album celebrating freedom and resilience with a mix of country, funk, and pop influences."
      }
    ];

    // Function to populate the page with album data
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Get album ID from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const albumId = urlParams.get('id');
        console.log('Album ID from URL:', albumId);

        if (!albumId) {
          throw new Error('No album ID provided in the URL.');
        }

        // Find the album in the data
        const album = albums.find(a => a.id === albumId);
        if (!album) {
          throw new Error(`Album with ID "${albumId}" not found.`);
        }
        console.log('Found album:', album);

        // Update Album Background
        const backgroundImg = document.getElementById('album-background');
        backgroundImg.src = album.cover;
        backgroundImg.onerror = () => {
          console.error(`Failed to load background image: ${album.cover}`);
          backgroundImg.src = 'assets/images/placeholder-background.webp';
        };
        document.getElementById('album-title').textContent = album.title;
        document.getElementById('album-subtitle').textContent = `A ${album.genre} Masterpiece by ${album.artist}`;

        // Update Album Details
        const coverImg = document.getElementById('album-cover');
        coverImg.src = album.cover;
        coverImg.alt = `${album.title} album cover`;
        coverImg.onerror = () => {
          console.error(`Failed to load album cover image: ${album.cover}`);
          coverImg.src = 'assets/images/placeholder-album.webp';
        };
        document.getElementById('album-info-title').textContent = album.title;
        document.getElementById('album-artist').innerHTML = `<strong>Artist:</strong> ${album.artist}`;
        document.getElementById('album-tracks').innerHTML = `<strong>Tracks:</strong> ${album.tracks.length > 0 && album.tracks[0] !== "" ? album.tracks.join(', ') : 'Track list unavailable'}`;
        document.getElementById('album-genre').innerHTML = `<strong>Genre:</strong> ${album.genre}`;
        document.getElementById('album-year').innerHTML = `<strong>Release Date:</strong> ${album.year}`;
        document.getElementById('album-description').textContent = album.artistInfo || "No description available.";

        // Update Streaming Links
        const linkTabs = document.getElementById('link-tabs');
        const platforms = [
          { name: 'Spotify', key: 'spotify' },
          { name: 'Apple Music', key: 'appleMusic' },
          { name: 'Amazon Music', key: 'amazonMusic' },
          { name: 'iHeartRadio', key: 'iHeartRadio' },
          { name: 'Boomplay', key: 'boomplay' },
          { name: 'Deezer', key: 'deezer' },
          { name: 'YouTube Music', key: 'youTubeMusic' },
          { name: 'iTunes', key: 'iTunes' }
        ];

        const validLinks = platforms.filter(platform => album.links[platform.key] && album.links[platform.key] !== '');
        if (validLinks.length > 0) {
          validLinks.forEach(platform => {
            const a = document.createElement('a');
            a.href = album.links[platform.key];
            a.target = '_blank';
            a.rel = 'noopener';
            a.className = 'link-tab';
            a.setAttribute('aria-label', `Stream on ${platform.name}`);
            a.textContent = platform.name;
            linkTabs.appendChild(a);
          });
        } else {
          linkTabs.innerHTML = '<p>No streaming links available for this album.</p>';
        }

        // Update Music Player Embed
        const musicPlayerEmbed = document.getElementById('music-player-embed');
        if (album.boomplayEmbed && album.boomplayEmbed !== '') {
          const iframe = document.createElement('iframe');
          iframe.src = album.boomplayEmbed;
          iframe.width = '100%';
          iframe.height = '100%';
          iframe.frameBorder = '0';
          musicPlayerEmbed.appendChild(iframe);
        } else {
          musicPlayerEmbed.innerHTML = '<p>No music player available for this album.</p>';
        }
      } catch (error) {
        console.error('Error loading album data:', error.message);
        displayError(
          "Error Loading Album",
          `We couldn’t load this album. Please try again later or <a href='music.html'>go back to the Music page</a>. Error: ${error.message}`
        );
      }
    });

    function displayError(title, subtitle) {
      console.error('Displaying error:', title, subtitle);
      document.getElementById('album-title').innerHTML = title;
      document.getElementById('album-subtitle').innerHTML = subtitle;
      document.getElementById('album-background').style.display = 'none';
      document.querySelector('.album-details').style.display = 'none';
      document.querySelector('.streaming-links').style.display = 'none';
      document.querySelector('.music-player').style.display = 'none';
      // Keep comments section visible
      const main = document.querySelector('.album-main');
      const errorContainer = document.createElement('section');
      errorContainer.className = 'error-section';
      errorContainer.innerHTML = `
        <h2>${title}</h2>
        <p>${subtitle}</p>
      `;
      main.prepend(errorContainer);
    }

    // === Comments Section Logic ===
    const sanitizeInput = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML
        .replace(/&/g, '&')
        .replace(/</g, '<')
        .replace(/>/g, '>')
        .replace(/"/g, '"')
        .replace(/'/g, '');
    };

    function showErrorToast(message) {
      const toast = document.getElementById('global-error-toast');
      if (toast) {
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      } else {
        console.warn('Error toast element not found. Check ID: global-error-toast');
      }
    }

    class RateLimiter {
      constructor(limit = 5, windowMs = 600000) { // 5 actions per 10 minutes
        this.limit = limit;
        this.windowMs = windowMs;
        this.requests = JSON.parse(sessionStorage.getItem(`commentRateLimit_${this.getUserId() || 'anonymous'}`)) || [];
      }

      getUserId() {
        const cachedAuth = sessionStorage.getItem('authState');
        if (cachedAuth) {
          try {
            const user = JSON.parse(cachedAuth);
            return user.uid;
          } catch (e) {
            console.warn('Invalid cached auth state:', e);
          }
        }
        return null;
      }

      canPerformAction() {
        const now = Date.now();
        this.requests = this.requests.filter(timestamp => now - timestamp < this.windowMs);
        if (this.requests.length >= this.limit) return false;
        this.requests.push(now);
        sessionStorage.setItem(`commentRateLimit_${this.getUserId() || 'anonymous'}`, JSON.stringify(this.requests));
        return true;
      }

      getRemainingTime() {
        const now = Date.now();
        const oldestRequest = this.requests[0] || now;
        return Math.max(0, this.windowMs - (now - oldestRequest));
      }
    }

    class CommentsManager {
      constructor(albumId) {
        if (!db || !auth) {
          throw new Error('Firebase not initialized');
        }
        this.albumId = albumId;
        this.rateLimiter = new RateLimiter();
        this.commentList = document.getElementById('comment-list');
        this.commentInput = document.getElementById('comment-input');
        this.submitButton = document.getElementById('submit-comment');

        if (!this.commentList) {
          console.error('Comment list element not found. Check ID: comment-list');
          return;
        }
        if (!this.commentInput) {
          console.error('Comment input element not found. Check ID: comment-input');
          return;
        }
        if (!this.submitButton) {
          console.error('Submit button not found. Check ID: submit-comment');
          return;
        }

        this.setupEventListeners();
        this.updateUI(null, null);
        this.renderComments();
      }

      setupEventListeners() {
        this.submitButton.addEventListener('click', () => this.postComment());
        this.commentList.addEventListener('click', (e) => this.handleCommentAction(e));

        onAuthStateChanged(auth, async (user) => {
          let userData = null;
          if (user) {
            try {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              userData = userDoc.exists() ? userDoc.data() : {};
            } catch (error) {
              console.error('Error fetching user data:', error);
              userData = { username: user.displayName || user.email || 'User' };
            }
          }
          console.log('Auth state changed:', user ? `Logged in as ${userData?.username || user?.displayName || user?.email}` : 'No user');
          this.updateUI(user, userData);
          this.renderComments();
        });
      }

      updateUI(user, userData) {
        if (user) {
          this.commentInput.disabled = false;
          this.submitButton.disabled = false;
        } else {
          this.commentInput.disabled = true;
          this.submitButton.disabled = true;
        }
      }

      async postComment() {
        const content = this.commentInput.value.trim();
        if (!content) {
          showErrorToast('Please enter a comment.');
          return;
        }

        if (!auth.currentUser) {
          showErrorToast('Please sign in to post a comment.');
          const loginBtn = document.getElementById('global-login-btn');
          if (loginBtn) loginBtn.click();
          return;
        }

        if (!this.rateLimiter.canPerformAction()) {
          const waitTime = Math.ceil(this.rateLimiter.getRemainingTime() / 1000);
          showErrorToast(`Please wait ${waitTime} seconds before posting another comment.`);
          return;
        }

        try {
          const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
          const userData = userDoc.exists() ? userDoc.data() : {};
          const comment = {
            uid: auth.currentUser.uid,
            username: userData.username || auth.currentUser.displayName || auth.currentUser.email || 'User',
            content: sanitizeInput(content),
            timestamp: new Date().toISOString(),
            likes: 0,
            dislikes: 0,
            likedBy: [],
            dislikedBy: []
          };

          await addDoc(collection(db, `albums/${this.albumId}/comments`), comment);
          console.log('Comment posted successfully:', comment);
          this.commentInput.value = '';
          this.renderComments();
        } catch (error) {
          console.error('Error posting comment:', error);
          showErrorToast('Failed to post comment. Please check your network or try again.');
        }
      }

      async deleteComment(commentId) {
        if (!auth.currentUser) {
          showErrorToast('Please sign in to delete comments.');
          const loginBtn = document.getElementById('global-login-btn');
          if (loginBtn) loginBtn.click();
          return;
        }

        if (!this.rateLimiter.canPerformAction()) {
          const waitTime = Math.ceil(this.rateLimiter.getRemainingTime() / 1000);
          showErrorToast(`Please wait ${waitTime} seconds before deleting another comment.`);
          return;
        }

        try {
          const commentRef = doc(db, `albums/${this.albumId}/comments`, commentId);
          await deleteDoc(commentRef);
          console.log('Comment deleted successfully:', commentId);
          this.renderComments();
        } catch (error) {
          console.error('Error deleting comment:', error);
          showErrorToast('Failed to delete comment. Please try again.');
        }
      }

      async handleCommentAction(e) {
        const target = e.target;
        if (!target.classList.contains('action-btn')) return;

        const commentId = target.dataset.commentId;
        const action = target.dataset.action;

        if (!auth.currentUser) {
          showErrorToast(`Please sign in to ${action.replace('-', ' ')} comments.`);
          const loginBtn = document.getElementById('global-login-btn');
          if (loginBtn) loginBtn.click();
          return;
        }

        try {
          const commentRef = doc(db, `albums/${this.albumId}/comments`, commentId);
          const commentDoc = await getDoc(commentRef);
          if (!commentDoc.exists()) {
            console.warn('Comment not found:', commentId);
            return;
          }
          let comment = commentDoc.data();

          if (action === 'like') {
            if (!this.rateLimiter.canPerformAction()) {
              const waitTime = Math.ceil(this.rateLimiter.getRemainingTime() / 1000);
              showErrorToast(`Please wait ${waitTime} seconds before liking another comment.`);
              return;
            }
            const userId = auth.currentUser.uid;
            if (comment.likedBy.includes(userId)) {
              comment.likedBy = comment.likedBy.filter(u => u !== userId);
              comment.likes--;
            } else {
              comment.likedBy.push(userId);
              comment.likes++;
              if (comment.dislikedBy.includes(userId)) {
                comment.dislikedBy = comment.dislikedBy.filter(u => u !== userId);
                comment.dislikes--;
              }
            }
            await updateDoc(commentRef, {
              likes: comment.likes,
              likedBy: comment.likedBy,
              dislikes: comment.dislikes,
              dislikedBy: comment.dislikedBy
            });
            console.log('Like updated:', commentId, comment.likes);
          } else if (action === 'dislike' && auth.currentUser.email === 'triadofangels@gmail.com') {
            if (!this.rateLimiter.canPerformAction()) {
              const waitTime = Math.ceil(this.rateLimiter.getRemainingTime() / 1000);
              showErrorToast(`Please wait ${waitTime} seconds before disliking another comment.`);
              return;
            }
            const userId = auth.currentUser.uid;
            if (comment.dislikedBy.includes(userId)) {
              comment.dislikedBy = comment.dislikedBy.filter(u => u !== userId);
              comment.dislikes--;
            } else {
              comment.dislikedBy.push(userId);
              comment.dislikes++;
              if (comment.likedBy.includes(userId)) {
                comment.likedBy = comment.likedBy.filter(u => u !== userId);
                comment.likes--;
              }
            }
            await updateDoc(commentRef, {
              likes: comment.likes,
              likedBy: comment.likedBy,
              dislikes: comment.dislikes,
              dislikedBy: comment.dislikedBy
            });
            console.log('Dislike updated:', commentId, comment.dislikes);
          } else if (action === 'delete-user' && comment.uid === auth.currentUser.uid) {
            await this.deleteComment(commentId);
          } else if (action === 'delete-admin' && auth.currentUser.email === 'triadofangels@gmail.com') {
            await this.deleteComment(commentId);
          }

          this.renderComments();
        } catch (error) {
          console.error(`Error performing ${action} action:`, error);
          showErrorToast(`Failed to ${action.replace('-', ' ')} comment. Please try again.`);
        }
      }

      async renderComments() {
        this.commentList.innerHTML = '';
        try {
          console.log('Fetching comments for album:', this.albumId);
          const q = query(collection(db, `albums/${this.albumId}/comments`), orderBy('timestamp', 'desc'));
          const querySnapshot = await getDocs(q);
          console.log('Comments retrieved:', querySnapshot.size);
          if (querySnapshot.empty) {
            this.commentList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
            return;
          }
          querySnapshot.forEach((doc) => {
            const comment = doc.data();
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';

            const header = document.createElement('div');
            header.className = 'comment-header';
            header.innerHTML = `
              <span>${comment.username}</span>
              <span class="timestamp">${
                comment.timestamp
                  ? typeof comment.timestamp.toDate === 'function'
                    ? comment.timestamp.toDate().toLocaleString()
                    : new Date(comment.timestamp).toLocaleString()
                  : 'Invalid timestamp'
              }</span>
            `;

            const content = document.createElement('div');
            content.className = 'comment-content';
            content.textContent = comment.content;

            const actions = document.createElement('div');
            const isAdmin = auth.currentUser && auth.currentUser.email === 'triadofangels@gmail.com';
            const isAuthor = auth.currentUser && comment.uid === auth.currentUser.uid;
            actions.className = `comment-actions ${isAdmin ? 'admin-view' : ''} ${isAuthor ? 'user-view' : ''}`;
            actions.innerHTML = `
              <button class="action-btn" data-comment-id="${doc.id}" data-action="like" ${!auth.currentUser ? 'disabled' : ''}>
                👍
              </button>
              <span>${comment.likes || 0}</span>
              <button class="action-btn admin-only" data-comment-id="${doc.id}" data-action="dislike" ${!isAdmin ? 'disabled' : ''}>
                👎
              </button>
              <span class="admin-only">${comment.dislikes || 0}</span>
              ${isAuthor ? `<button class="action-btn delete-btn user-only" data-comment-id="${doc.id}" data-action="delete-user" title="Delete your comment">🗑️</button>` : ''}
              ${isAdmin ? `<button class="action-btn delete-btn admin-delete-btn admin-only" data-comment-id="${doc.id}" data-action="delete-admin" title="Admin delete comment">🗑️ Admin</button>` : ''}
            `;

            commentDiv.appendChild(header);
            commentDiv.appendChild(content);
            commentDiv.appendChild(actions);
            this.commentList.appendChild(commentDiv);
          });
        } catch (error) {
          console.error('Error rendering comments:', error);
          this.commentList.innerHTML = '<p>Failed to load comments. Please try again later.</p>';
        }
      }
    }

    function initializeComments(albumId) {
      try {
        const commentsManager = new CommentsManager(albumId);
        commentsManager.renderComments();
      } catch (error) {
        console.error('Error initializing comments:', error);
        showErrorToast('Failed to initialize comments. Please try again later.');
      }
    }

    // Ensure Firebase is loaded before initializing comments
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const albumId = urlParams.get('id');
      if (albumId) {
        initializeComments(albumId);
      }
    });
  </script>
  <script>
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  </script>
  <script>
    // Mobile menu toggle
    document.documentElement.style.scrollBehavior = 'smooth';
    const toggleButton = document.getElementById('mobile-menu-toggle');
    const navMenu = document.getElementById('main-nav');
    if (toggleButton && navMenu) {
      toggleButton.addEventListener('click', () => {
        const isExpanded = navMenu.classList.toggle('show');
        toggleButton.setAttribute('aria-expanded', isExpanded);
      });
    }
  </script>
  <script src="/js/chatbot.js"></script>
  <script src="/js/chatbot-persist.js"></script>
  <script src="/js/firebase-init.js"></script>
  <script src="/js/auth.js"></script>
</body>
</html>